<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Projects - Trisha Tong</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="theme-toggle.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        table, th, td {
          border: 1px solid black;
        }
    </style>
    <!-- custom font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <input type="checkbox" id="menu-toggle" class="menu-checkbox">
        <label for="menu-toggle" class="hamburger">â˜°</label>
        <nav>
            <ul class="nav-links">
              <li><a href="index.html">home</a></li>
              <li><a href="projects.html">projects</a></li>
              <li><a href="blog.html">case study</a></li>
              <li><a href="about.html">about</a></li>
              <li>
                <button id="theme-toggle" aria-label="Toggle Dark/Light Mode" class="theme-toggle">
                    ðŸŒž
                </button>
              </li>
            </ul>
            <form class="search" onsubmit="return globalSearch(event)">
                <input type="text" id="search-input" placeholder="search...">
                <button type="submit">search</button>
            </form>
        </nav>
    </header>
    <main>
        <section>
            <h2 class="project-header">some of my projects</h2>
            <!-- CHANGE 3: Add a Filter By Tag -->
            <!-- highlight: add interactivity using data already in memory from Firestore -->

            <!-- UI for tag filter: JS reads user input -->
            <!-- <div id="tag-filter">
              <input type="text" id="tagInput" placeholder="Enter tag (e.g., JavaScript)">
              <button id="filterButton" >Filter</button>
              <button id="clearFilterButton">Clear</button>
            </div> -->
            <div id="projects-container"></div>
        </section>
    </main>
    <script src="themeToggle.js"></script>
    <script src="projectCard.js"></script>
    <script src="search.js"></script>

<!-- Firebase Firestore live data -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, query, orderBy, onSnapshot }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD7LlpL5K7INLxJ0o_-9azoXNJPCwcgLK4",
  authDomain: "personal-site-e4468.firebaseapp.com",
  projectId: "personal-site-e4468",
  storageBucket: "personal-site-e4468.firebasestorage.app",
  messagingSenderId: "95913395306",
  appId: "1:95913395306:web:7565165ff24e6786b9b613",
  measurementId: "G-M8Y85P733T"
};

  const app = initializeApp(firebaseConfig); // connects website to exact Firebase project
  const db = getFirestore(app); // returns Firestore database

  const projectsRef = collection(db, "projects");

  // --- CHANGE 1: Change Sorting Behavior ---
  // highlight: data adjustment through changing backend query logic without touching underlying dataset
  const q = query(projectsRef, orderBy("importance", "desc")); // backend query: sorts projects by importance

  // returns year
  function toDateString(dateField) {
    if (!dateField) return "unknown";

    try {
      let date;
      if (typeof dateField.toDate === "function") {
        date = dateField.toDate();
      } else {
        date = new Date(dateField); 
      }
      return date.getFullYear();
    } catch (err) {
      console.error("Invalid date:", dateField, err);
      return "unknown";
    }
  }

  // HTML escape utility to prevent HTML from breaking and protect against XSS
  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => (
      { "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[c]
    ));
  }

  // --- CHANGE 2: Add a New Field (mode) to Display --- 
  // highlight: add new field in Firestore -> update UI (FE + BE)
  function renderProjects(items) {
    const container = document.getElementById("projects-container");
    container.innerHTML = ""; // clear old content

    // loop through each project from Firestore and create a custom <project-card> element
    items.forEach(p => {
      const card = document.createElement("project-card"); // create a new custom project card element
      
      card.setAttribute("title", p.title || ""); // set attribute for card so <project-card> component knows what to display
      card.setAttribute("image", p.image || "");
      card.setAttribute("description", p.description || "");
      card.setAttribute("link", p.link || "");
      card.setAttribute("date", toDateString(p.date));
      card.setAttribute("tags", Array.isArray(p.tags) ? p.tags.join(", ") : "");

      container.appendChild(card);
    });

    if (!items.length) {
      container.innerHTML = "<p>No projects yet.</p>";
    }
}

let allProjects = []; // stores all projects when they first load to filter without refetching

// realtime Firestore listener -> map docs to objects -> update UI
onSnapshot(q, (snap) => {
  const data = snap.docs.map(d => ({ id: d.id, ...d.data() })); // map Firestore docs to objects (only used in this function call)
  renderProjects(data); // render projects immediately
  
  // allProjects = snap.docs.map(d => ({ id: d.id, ...d.data() })); // map Firestore docs to objects and store globally for filtering
  // renderProjects(allProjects); // render filtered 

}, (err) => {
  console.error(err);
  document.getElementById("projects-container").textContent = "Error loading projects.";
});

// document.getElementById("filterButton").addEventListener("click", () => { 
//   const tag = document.getElementById("tagInput").value.trim().toLowerCase();   // remove extra spaces, make lowercase

//   if (!tag) return renderProjects(allProjects); // if user didnâ€™t type anything, skip filtering -> render all projects again

//   const filtered = allProjects.filter(p =>
//     Array.isArray(p.tags) && // checks p.tags is an array to prevent crashing
//     p.tags.some(t => t.toLowerCase().includes(tag)) // check if any tag in that project contains search term
//   );

//   renderProjects(filtered); // render page with filtered results
// });

// document.getElementById("clearFilterButton").addEventListener("click", () => {
//   document.getElementById("tagInput").value = ""; // empty input field
//   renderProjects(allProjects); // re-render
// });

</script>

<footer>
    <p>Â© 2025 Trisha Tong</p>
</footer>
</body>
</html>